---
description: "Standard Operating Procedure: Editing a workflow. Tactical steps for the agent to follow when modifying an existing workflow."
globs: []
alwaysApply: false
---
## SOP: Edit Workflow

**Context:** This rule is loaded when the user is on the workflow edit page. The agent is already viewing/editing a specific workflow.

### Step 1: Understand What Needs to Change

Clarify with the user:
- What aspect of the workflow needs modification (metadata, steps, logic)?
- Are they adding, removing, or modifying steps?
- Do they want to change workflow behavior or just fix an error?

### Step 2: Review Current Workflow

**Available in context:**
- `title` - Workflow name
- `description` - One-sentence summary
- `scenario` - Human-readable step breakdown (what the workflow does in plain English)
- `content` - The full `.wf.md` workflow definition

**Action:** Read the current workflow content to understand its structure before making changes. Pay attention to:
- What tools are being used
- How steps reference each other's outputs
- Whether it uses parameters, iterators, or branches

### Step 3: Make the Requested Modification

**For metadata changes (title, description, scenario):**

Use `ui_fill_state` to update specific fields:

```json
{
  "store_name": "workflow",
  "state_path": "workflowEditState",
  "updates": {
    "title": "New Title"
  }
}
```

**Important:** Only include the fields you're changing. Other fields will be preserved.

**For workflow content changes (steps, logic):**

1. Get the current content from context
2. Modify the specific section
3. Submit the complete updated content:

```json
{
  "store_name": "workflow",
  "state_path": "workflowEditState",
  "updates": {
    "content": "---\ntitle: ...\n--- \n## Step 1: ...\n..."
  }
}
```

### Step 4: Validate the Changes

**⚠️ VALIDATION CHECKLIST (Run through this BEFORE submitting):**

| Check | What to Verify |
|-------|----------------|
| ✅ Variable references | All `${stepN.var}` references point to existing outputs |
| ✅ Scope rules | Child step outputs not accessed from outside containers |
| ✅ Step numbering | Steps are numbered sequentially (1, 2, 3...) |
| ✅ Required fields | Each step has either `**Tool:**` or `**Type:**` |
| ✅ Parameters declared | Every `${workflow.params.X}` has matching entry in `parameters:` block |
| ✅ LLM model valid | Every `llm` step has `model: "anthropic/claude-sonnet-4-5"` (or other valid model) |
| ✅ LLM inputs complete | Every `llm` step has `system_prompt`, `user_prompt`, AND `model` |
| ✅ Frontmatter valid | YAML syntax is correct, required fields present |

**If you removed a step:**
- Check that no later steps reference its outputs
- Update step numbers if needed

**If you added an LLM step:**
- Include ALL three required inputs: `system_prompt`, `user_prompt`, `model`
- Use a valid model from `WORKFLOW_TOOLING`

**If you modified workflow parameters:**
- Ensure `parameters:` block in frontmatter matches all `${workflow.params.*}` usage

**Reference:** Check against `WORKFLOW_SYNTAX`, `WORKFLOW_PATTERNS`, and `WORKFLOW_TOOLING` as needed.

### Step 5: After Saving

- Changes are applied immediately
- Inform user what you changed
- If the user wants to test, you can navigate to the execution page

### Common Editing Tasks

**Task: Rename a workflow**
```json
{
  "store_name": "workflow",
  "state_path": "workflowEditState",
  "updates": {
    "title": "New Workflow Name"
  }
}
```

**Task: Update the scenario (human-readable summary)**

The `scenario` field is a **human-readable step breakdown** of what the workflow does. When editing a workflow, update the scenario to match any changes you make to the steps.

```json
{
  "store_name": "workflow",
  "state_path": "workflowEditState",
  "updates": {
    "scenario": "1. Fetch all calendar events for the week\n2. Analyze events and identify key meetings\n3. Generate formatted summary\n4. Create Google Doc with results"
  }
}
```

**Why this matters:** Users who don't understand workflow syntax rely on the scenario to understand what the workflow does.

**Task: Add a new step**
1. Read current content
2. Append new step with proper numbering
3. Update content field with modified version

**Task: Modify an existing step**
1. Read current content
2. Locate and modify the target step
3. Update content field with modified version

**Task: Fix a variable reference**
1. Identify the broken reference
2. Update it to point to the correct output
3. Submit updated content

### Common Pitfalls to Avoid

1. **Don't clear other fields** - Only update what needs to change
2. **Don't break variable chains** - If you remove a step, check what depends on it
3. **Don't forget to test tools** - If you're adding a new tool, verify it works
4. **Don't submit partial content** - When editing content, submit the full `.wf.md`
5. **Don't skip validation** - Catch errors before saving
6. **Don't forget `parameters:`** - If adding `${workflow.params.X}`, ensure X is declared in frontmatter
7. **Don't forget `model:` in LLM steps** - Every `llm` step needs `model: "anthropic/claude-sonnet-4-5"` (or other valid model)
8. **Don't use Brave Search for web research** - Use `llm` tool instead (proper output format)
9. **Don't forget to update the scenario** - If you changed what the workflow does, update the scenario to match
