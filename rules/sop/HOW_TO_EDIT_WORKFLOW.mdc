---
description: "Operational Protocol: Editing a workflow. State-based guidance for helping users modify existing workflows."
globs: []
alwaysApply: false
---

# Protocol: Edit Workflow

**Purpose:** Guide the user through modifying an existing workflow's metadata, steps, or logic.

**Prerequisites:**
- User is on `/workflow-edit/:id` page
- An existing workflow is loaded for editing
- User has identified what they want to change

---

## State Machine Overview

```
UNDERSTAND → REVIEW → MODIFY → VALIDATE → SAVE → COMPLETE
    ↑           │         │
    └───────────┴─────────┘ (can return if issues found)
```

---

## Planning

This protocol is multi-step and stateful. When it is loaded, your **next assistant message must include a plan** before any tool call.

Output the plan as a single JSON object in a `json` code block, using:
- `goal`, `current_state`, `steps`, `decision_points`, `verification`
- step `status`: `todo` | `doing` | `done` | `blocked`

Example:

```json
{
  "goal": "Edit an existing workflow",
  "current_state": {
    "page": "/workflow-edit/…",
    "workflow_id": "…"
  },
  "steps": [
    {"id": "UNDERSTAND", "status": "doing"},
    {"id": "REVIEW", "status": "todo"},
    {"id": "MODIFY", "status": "todo"},
    {"id": "VALIDATE", "status": "todo"},
    {"id": "SAVE", "status": "todo"},
    {"id": "COMPLETE", "status": "todo"}
  ],
  "decision_points": [
    "Confirm intended change scope (metadata vs content vs logic)",
    "If change impacts behavior, confirm before saving"
  ],
  "verification": [
    "After SAVE, tool result shows success and the edited workflow reflects the changes"
  ]
}
```

Update this plan as you progress (mark statuses, add brief notes).

---

## State: UNDERSTAND

### Indicators
- User has requested a change to the workflow
- The specific modification needed is not yet clear
- You need to clarify what aspect to modify

### Context Check
- Verify current page via `page.full_path` (should be `/workflow-edit/*`)
- Check `data.workflowEditState` for current workflow content

### Goal
Clarify exactly what the user wants to modify.

### Actions

**1. Ask clarifying questions:**
- What aspect needs modification (metadata, steps, logic)?
- Are they adding, removing, or modifying steps?
- Is this a fix for an error or a feature addition?

**2. Categories of changes:**

| Category | What it affects | Complexity |
|----------|----------------|------------|
| Metadata | Title, description, scenario | Simple |
| Step parameters | Input values within a step | Moderate |
| Step logic | Adding/removing/reordering steps | Complex |
| Variable references | Output extraction and references | Requires validation |

### Transitions
- User clarifies what to change → **REVIEW**
- Already clear from initial request → **REVIEW**

---

## State: REVIEW

### Indicators
- Modification type is understood
- Need to examine current workflow structure
- Haven't yet identified what specifically to edit

### Context Check
```
data.workflowEditState.content: Current workflow .wf.md content
data.workflowEditState.title: Current title
data.workflowEditState.scenario: Current category
```

### Goal
Understand the current workflow structure before making changes.

### Actions

**1. Read current workflow from context:**
- Examine `data.workflowEditState.content`
- Identify frontmatter, steps, variables

**2. Map the workflow structure:**
- List all steps and their tools
- List all variable definitions (outputs)
- List all variable references (inputs using `${...}`)

**3. Identify the section(s) to modify:**
- For metadata: frontmatter or top-level fields
- For steps: specific `## Step N` section
- For variables: output definitions or input references

### Transitions
- Section to modify identified → **MODIFY**
- Need to verify tool behavior → Load `WORKFLOW_TOOLING` then **MODIFY**
- Current structure is unclear → Ask user for clarification

---

## State: MODIFY

### Indicators
- Current workflow structure is understood
- Ready to make the requested modification
- Know which section(s) need to change

### Context Check
- Reference `WORKFLOW_SYNTAX` for correct format if needed
- Check tool signatures if changing tool parameters

### Goal
Make the specific modification requested.

### Actions

**For metadata changes (title, description, scenario):**

```
TOOL_CALL: {"name": "ui_fill_state", "parameters": {"store_id": "workflow", "updates": {"workflowEditState": {"title": "New Title"}}}}
```

**Important:** Only include fields you're changing. Other fields are preserved.

**For workflow content changes:**

1. Get the current content from context
2. Modify the specific section
3. Submit the complete updated content:

```
TOOL_CALL: {"name": "ui_fill_state", "parameters": {"store_id": "workflow", "updates": {"workflowEditState": {"content": "---\ntitle: ...\n--- \n## Step 1: ...\n..."}}}}
```

**Common modification patterns:**

| Task | Approach |
|------|----------|
| Rename workflow | Update `title` field only |
| Change category | Update `scenario` field only |
| Add new step | Append to content with proper numbering |
| Modify step inputs | Update specific step's **Inputs:** section |
| Change tool | Update **Tool:** line and verify new signature |
| Fix variable reference | Update `${...}` expression |
| Remove step | Remove entire `## Step N` section, renumber remaining |

### Transitions
- Modification applied → **VALIDATE**
- Need to verify tool signature → Query tool, then return to **MODIFY**
- Unclear how to implement change → Ask user for clarification

---

## State: VALIDATE

### Indicators
- Modification has been applied to the form
- Need to verify the changes are correct
- Haven't yet confirmed syntax and references are valid

### Context Check
```
data.workflowEditState.content: Updated content
data.workflowEditState.title: Updated title (if changed)
```

### Goal
Verify the modifications maintain workflow validity.

### Actions

**1. Validation checklist:**

- [ ] If steps modified: All variable references are still valid
- [ ] If step added: It has required fields (`**Tool:**` or `**Type:**`)
- [ ] If step removed: No later steps reference its outputs
- [ ] If tool changed: New tool exists and has been verified
- [ ] Frontmatter is still valid (if touched)
- [ ] Step numbering is sequential

**2. If adding a new tool, verify it exists:**

```
TOOL_CALL: {"name": "get_mcp_tool_schema", "parameters": {"tool_name": "server_name__tool_name"}}
```

**3. If validation fails:**
- Identify the specific issue
- Return to **MODIFY** to fix

### Transitions
- All validations pass → **SAVE**
- Validation fails → Return to **MODIFY**
- Missing information → Query tools or ask user

---

## State: SAVE

### Indicators
- Modifications are validated
- Ready to persist changes
- Save button should be available

### Context Check
```
elements: Must include the save/update button for this page (exact ID varies)
data.workflowEditState: Should show modified values
```

### Goal
Save the modified workflow and verify success.

### Actions

**1. Click the save button:**

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "[SAVE_WORKFLOW_BUTTON_ID]"}}
```

**2. Verify result:**

Check the tool result:
- `success: true` → Proceed to **COMPLETE**
- `success: false` → Read error message

**3. If save failed:**

| Error | Cause | Fix |
|-------|-------|-----|
| "Invalid syntax" | Malformed workflow content | Check format in WORKFLOW_SYNTAX |
| "Variable not found" | Dangling reference | Check step outputs |
| "Invalid tool" | Tool name typo or removed | Verify tool exists |

### Transitions
- Save successful → **COMPLETE**
- Save failed with fixable error → Return to **MODIFY**
- Save failed with unclear error → Return to user with status

---

## State: COMPLETE

### Indicators
- Changes have been saved
- Workflow is updated in the system

### Actions

**1. Confirm what was changed:**

```
✅ **Workflow updated successfully!**

**Changes made:**
- [List specific changes]

**Would you like to:**
- Run the workflow to test the changes?
- Make additional modifications?
```

**2. Offer logical next action:**
- Test changes → Navigate to execution page
- Continue editing → Return to **UNDERSTAND**
- Done → User can navigate away

---

## Common Pitfalls

1. **Clearing other fields**: Only update what needs to change—other fields are preserved.

2. **Breaking variable chains**: If you remove a step, check what depends on its outputs.

3. **Not testing tools**: If adding a new tool, verify it works before saving.

4. **Submitting partial content**: When editing content, submit the full `.wf.md`, not fragments.

5. **Skipping validation**: Catch errors before saving—saves time and frustration.

6. **Wrong step numbering**: After adding/removing steps, ensure sequential numbering.

7. **Not verifying save succeeded**: Always check the tool result before confirming to user.
