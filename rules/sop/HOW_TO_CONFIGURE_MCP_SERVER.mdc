---
description: "Operational Protocol: Configuring an MCP Server with credentials. State-based guidance for helping users add their credentials to an existing server template."
globs: []
alwaysApply: false
---

# Protocol: Configure MCP Server

**Purpose:** Guide the user through adding their credentials/settings to an existing MCP server template so they can use it.

**Prerequisites:**
- An MCP server template exists on the platform
- User wants to add their credentials to use this server

---

## ⚠️ Critical: Element ID Rules

**NEVER guess or construct element IDs.** Always:

1. Look in the `elements` array from context for the exact `id` value
2. Use that `id` value exactly as provided
3. If an element is not in `elements`, it cannot be clicked

Common element IDs for this flow (always verify in context):
- Configure modal button: `configure-server-{server_id}`
- Tab navigation: `mcp-modal-tab-configs`, `mcp-modal-tab-configure`, `mcp-modal-tab-settings`
- Create config: `create-new-config-btn`
- Save config: `save-config-btn`
- Toggle server: `toggle-server-{server_id}`
- Close modal: `close-mcp-server-modal-btn`

---

## State Machine Overview

```
CONFIG_LIST → CREATE_OR_EDIT → FORM_FILL → [OAUTH_FLOW] → SAVE_CONFIG → ACTIVATION → ENABLE_SERVER → COMPLETE
                                ↑                         │
                                └─────────────────────────┘ (if save fails)
```

---

## Planning

This protocol is multi-step and stateful. When it is loaded, your **next assistant message must include a plan** before any action.

Output the plan as a single JSON object in a `json` code block, using:
- `goal`, `current_state`, `steps`, `decision_points`, `verification`
- step `status`: `todo` | `doing` | `done` | `blocked`

Example:

```json
{
  "goal": "Configure and enable an MCP server for the user",
  "current_state": {
    "page": "/features?action=configure&server_id=…",
    "server": "…"
  },
  "steps": [
    {"id": "CONFIG_LIST", "status": "doing"},
    {"id": "CREATE_OR_EDIT", "status": "todo"},
    {"id": "FORM_FILL", "status": "todo"},
    {"id": "OAUTH_FLOW", "status": "todo"},
    {"id": "SAVE_CONFIG", "status": "todo"},
    {"id": "ACTIVATION", "status": "todo"},
    {"id": "ENABLE_SERVER", "status": "todo"},
    {"id": "COMPLETE", "status": "todo"}
  ],
  "decision_points": [
    "Create a new configuration vs edit an existing one",
    "If OAuth, user must confirm they are ready to connect"
  ],
  "verification": [
    "Config saved (or OAuth completed) and appears in data.configurations",
    "Desired config is active",
    "Server is enabled on the main Connections list"
  ]
}
```

Update this plan as you progress (mark statuses, add brief notes).

---

## State: CONFIG_LIST

### Indicators
- Configure modal is open (or needs to be opened)
- On `configs` tab viewing existing configurations
- Need to understand current configuration state

### Context Check
```
page.full_path: "/features?action=configure&server_id=[ID]" or similar
data.configurations: List of existing configs (may be empty)
data.activeTab: Should be "configs"
```

### Goal
Understand what configurations exist and decide whether to create new or edit existing.

### Actions

**1. If modal not open, open it:**

Check `page.full_path` for the configure action. If not present, open the modal by looking in `elements` for `configure-server-{server_id}`:

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "configure-server-{server_id}"}}
```

> **CRITICAL:** Use the EXACT `id` from `elements` array. Replace `{server_id}` with the actual ID from `data.servers`.

**2. Review existing configurations:**

From `data.configurations`, note:
- How many configs exist
- Which one is active (if any)
- Config names and their status

**3. Inform user of current state:**

```
**Current configuration status for [Server Name]:**
- Configurations: [N] saved
- Active config: [name] or "None"

Would you like to:
1. Create a new configuration
2. Edit existing configuration "[name]"
3. Activate a different configuration
```

### Transitions
- User wants new config → **CREATE_OR_EDIT** (create mode)
- User wants to edit existing → **CREATE_OR_EDIT** (edit mode)
- User wants to activate existing → **ACTIVATION**
- Need to understand form fields first → Stay here, review server template

---

## State: CREATE_OR_EDIT

### Indicators
- Decision made: creating new OR editing existing
- Need to access the configuration form
- On `configs` tab, need to switch to `configure` tab

### Context Check
```
elements: Must include the create/edit configuration buttons (exact IDs vary)
data.activeTab: Currently "configs", will change to "configure"
```

### Goal
Navigate to the configuration form with appropriate mode (empty for new, populated for edit).

### Actions

**For new configuration:**

Look in `elements` for `create-new-config-btn`:

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "create-new-config-btn"}}
```

**For editing existing:**

Look in `elements` for `edit-config-{config_id}`:

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "edit-config-{config_id}"}}
```

> **CRITICAL:** Always use the EXACT `id` from `elements`. Never construct or guess IDs.

**Verify transition:**
- `data.activeTab` should change to "configure"
- For edit: `data.configForm` should show existing values
- For new: `data.configForm` should be empty/default

### Transitions
- Form displayed → **FORM_FILL**
- Navigation failed → Check element IDs in context, retry

---

## State: FORM_FILL

### Indicators
- On `configure` tab
- Form is displayed (empty or pre-populated)
- Need to enter/modify configuration values

### Context Check
```
data.configForm: Current form state
data.serverTemplate.ui_schema: Defines what fields exist
data.serverTemplate.variable_schema: Defines field types and requirements
elements: Form elements and submit button
```

### Goal
Fill all required fields with user's credentials/settings.

### Actions

**1. Understand required fields:**

From `data.serverTemplate.variable_schema`, identify:
- Required fields (`required` array)
- Field types and descriptions
- Default values (if any)

**2. Determine what information you need from user:**

If user hasn't provided credentials:
```
To configure [Server Name], I need the following information:

**Required:**
- [Field 1]: [Description from schema]
- [Field 2]: [Description from schema]

**Optional:**
- [Field 3]: [Description] (default: [value])

Do you have these credentials ready?
```

**3. Fill the form:**

Once you have values:
```
TOOL_CALL: {"name": "ui_fill_state", "parameters": {"store_id": "mcp", "updates": {"configForm": {"config_name": "My Config Name", "variables": {"api_key": "[USER_VALUE]", "base_url": "[USER_VALUE]"}}}}}
```

**4. Verify in next context:**
- `data.configForm.config_name` should show the name
- `data.configForm.variables` should show the values
- For secret fields, values may show masked

### Field Types

| Type | How to Fill |
|------|-------------|
| `text` | String value directly |
| `password` | String value (will be encrypted) |
| `checkbox` | Array of selected option values |
| `textarea` | Multi-line string |

### Important Notes

- **Secret values cannot be retrieved after save** - they're encrypted one-way
- **Don't ask users to paste secrets in chat if avoidable** - guide them to enter in the form directly
- **Config name should be descriptive** - helps when user has multiple configs

### Transitions
- Form filled and verified → **OAUTH_FLOW** (if OAuth) or **SAVE_CONFIG**
- Missing information from user → Wait for input
- Form fill failed → Check error, retry

---

## State: OAUTH_FLOW

### Indicators
- Server template has `oauth_enabled: true`
- Configuration requires OAuth authentication
- Need to initiate browser-based authorization

### Context Check
```
data.serverTemplate.oauth_enabled: true
data.serverTemplate.oauth_handler_type: "google" | "discord" | etc.
elements: Should include OAuth connect button
```

### Goal
Guide user through OAuth authorization flow.

### Actions

**1. Fill any non-OAuth fields first** (in FORM_FILL state)

Some OAuth servers still have additional config fields (like scope selection):
```
TOOL_CALL: {"name": "ui_fill_state", "parameters": {"store_id": "mcp", "updates": {"configForm": {"config_name": "Work Google Account", "variables": {"enabled_capabilities": ["gmail", "calendar", "drive"]}}}}}
```

**2. Explain what will happen:**

```
This server uses OAuth authentication with [Provider].

When you click "Connect with [Provider]":
1. A new window will open for [Provider] login
2. You'll authorize Arclio to access your account
3. After authorization, you'll return here automatically

Ready to connect?
```

**3. Initiate OAuth:**

Look in `elements` for `connect-oauth-btn`:

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "connect-oauth-btn"}}
```

**4. After OAuth completes:**

User will return to `/features?oauth_status=success` (or similar).
The configuration is automatically saved upon successful OAuth.

### OAuth Errors

| Status | Meaning | Action |
|--------|---------|--------|
| `oauth_status=success` | Authorization complete | Proceed to ACTIVATION |
| `oauth_status=error` | Authorization failed | Check error param, inform user |
| `oauth_status=cancelled` | User cancelled | Ask if they want to retry |

### Transitions
- OAuth successful → **ACTIVATION** (config auto-saved)
- OAuth failed → Diagnose error, may retry or return to user
- User cancelled → Ask how to proceed

---

## State: SAVE_CONFIG

### Indicators
- Form is completely filled
- NOT an OAuth server (OAuth saves automatically)
- Ready to persist the configuration

### Context Check
```
data.configForm: Fully populated
elements: Should include save button
```

### Goal
Save the configuration and verify success.

### Actions

**1. Click save:**

Look in `elements` for `save-config-btn`:

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "save-config-btn"}}
```

> **CRITICAL:** Use the EXACT `id` from `elements` array.

**2. Verify tool result:**
- `success: true` → Configuration saved
- `success: false` → Read error, handle accordingly

**3. Verify context change:**
- Should return to `configs` tab or show success state
- New config should appear in `data.configurations`

### Common Errors

| Error | Cause | Fix |
|-------|-------|-----|
| "Missing required field" | Required variable not filled | Return to FORM_FILL |
| "Invalid format" | Value doesn't match expected format | Check field requirements |
| "Duplicate name" | Config name already exists | Change config_name |

### Transitions
- Save successful → **ACTIVATION**
- Save failed with fixable error → Return to **FORM_FILL**
- Save failed with unclear error → Return to user with status

---

## State: ACTIVATION

### Indicators
- Configuration exists and is saved
- Configuration may not be active
- Server may have multiple configurations

### Context Check
```
data.configurations: List including the new/edited config
data.configurations[].is_active: Which config is currently active
```

### Goal
Ensure the desired configuration is active.

### Actions

**1. Check if activation needed:**

If the configuration is already active, skip to ENABLE_SERVER.

**2. Activate the configuration:**

Look in `elements` for `activate-config-{config_id}`:

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "activate-config-{config_id}"}}
```

**3. Verify activation:**
- The config should now show `is_active: true`
- Previous active config (if any) should show `is_active: false`

### Important Notes

- **Only one config per server can be active** - activating one deactivates others
- **Activation doesn't enable the server** - that's a separate step
- **For OAuth servers**, activation may trigger token refresh

### Transitions
- Configuration activated → **ENABLE_SERVER**
- Activation failed → Check error, may need to return to earlier state

---

## State: ENABLE_SERVER

### Indicators
- Configuration is saved and active
- Server itself may not be enabled in the MCP hub
- Need to toggle server on

### Context Check
```
page.full_path: Back on /features main view (not in modal)
data.servers: List of servers with enabled status
elements: Should include server toggle elements
```

### Goal
Enable the server so its tools become available.

### Actions

**1. Close modal if still open:**

If still in configure modal, look in `elements` for `close-mcp-server-modal-btn`:

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "close-mcp-server-modal-btn"}}
```

**2. Find and toggle the server:**

Look in `elements` for `toggle-server-{server_id}`:

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "toggle-server-{server_id}"}}
```

> **CRITICAL:** Always use EXACT `id` values from `elements`. Never guess or construct IDs.

**3. Verify server is enabled:**
- Server should show "Active" or "Enabled" status
- Server's tools should now be available via MCP

**4. Confirm to user:**

```
✅ **[Server Name] is now configured and enabled!**

**Configuration:** [Config Name]
**Status:** Active

The server's tools are now available. You can:
- Use them in workflows
- View available tools by clicking "View Tools"
- Create additional configurations for different accounts/environments

Would you like to see what tools are available?
```

### Transitions
- Server enabled → **COMPLETE**
- Enable failed → Check if configuration is active, may need earlier steps

---

## State: COMPLETE

### Indicators
- The server is enabled (or the user explicitly chose not to enable yet)
- The user has what they need to proceed (use tools in a workflow, test tools, etc.)

### Goal
Close the loop and offer the next logical action.

### Actions
- Confirm success and summarize:
  - Server name
  - Active configuration name (if applicable)
  - What the user can do next
- If the user wants to validate tools, suggest viewing tools or testing a tool in a workflow.

---

## Common Pitfalls

1. **Skipping to enable without active config**: Server won't enable without an active configuration.

2. **Trying to save OAuth config manually**: OAuth configs save automatically after the flow completes.

3. **Expecting to view saved secrets**: Secret values are encrypted and cannot be retrieved—only replaced.

4. **Forgetting to close modal**: The server toggle is on the main page, not in the modal.

5. **Multiple configs confusion**: Only ONE config per server can be active. Clarify with user which environment/account they want active.
