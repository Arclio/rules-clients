---
description: "Operational Protocol: Creating an application. State-based guidance for helping users create new applications via the create modal."
globs: []
alwaysApply: false
---

# Protocol: Create Application

**Purpose:** Guide the user through creating a new schema-driven dashboard application.

**Prerequisites:**
- User is on `/applications?create=true` (create modal is open)
- User has identified what they want the application to display

---

## State Machine Overview

```
UNDERSTAND → DESIGN → FORM_FILL → VALIDATE → SAVE → COMPLETE
    ↑           │          │
    └───────────┴──────────┘ (can return if issues found)
```

---

## Planning

This protocol is multi-step and stateful. When it is loaded, your **next assistant message must include a plan** before any tool call.

Output the plan as a single JSON object in a `json` code block, using:
- `goal`, `current_state`, `steps`, `decision_points`, `verification`
- step `status`: `todo` | `doing` | `done` | `blocked`

Example:

```json
{
  "goal": "Create a new application (dashboard)",
  "current_state": {
    "page": "/applications?create=true",
    "have_requirements": false
  },
  "steps": [
    {"id": "UNDERSTAND", "status": "doing"},
    {"id": "DESIGN", "status": "todo"},
    {"id": "FORM_FILL", "status": "todo"},
    {"id": "VALIDATE", "status": "todo"},
    {"id": "SAVE", "status": "todo"},
    {"id": "COMPLETE", "status": "todo"}
  ],
  "decision_points": [
    "Confirm dashboard requirements before drafting the manifest",
    "Confirm before saving if the dashboard will trigger workflows / write actions"
  ],
  "verification": [
    "After SAVE, tool result shows success and the application appears in the applications list"
  ]
}
```

Update this plan as you progress (mark statuses, add brief notes).

---

## State: UNDERSTAND

### Indicators
- User has requested a new application/dashboard
- The specific requirements are not yet fully understood
- You don't know what data, components, or actions are needed

### Context Check
- `page.full_path` should be `/applications?create=true`
- `data.applicationCreationState` should be present (create modal form state)
- `elements` should include the create/submit button and any required fields

### Goal
Clarify the user's requirements before designing the application.

### Actions

**1. Ask clarifying questions if needed:**
- What is the purpose of this application/dashboard?
- What data should be displayed (tables, charts, metrics)?
- What actions should users be able to trigger?
- Are there existing workflows or MCP tools to integrate?

**2. Summarize understanding:**

```
I understand you want to create a dashboard that:
- Displays: [data types]
- Components: [chart, table, metrics, etc.]
- Actions: [workflow triggers, etc.]

Is that correct?
```

### Transitions
- User confirms understanding → **DESIGN**
- User provides more requirements → Remain in **UNDERSTAND**
- Requirements are already clear → **DESIGN**

---

## State: DESIGN

### Indicators
- Requirements are understood
- Need to plan the manifest structure
- Haven't yet designed the layout and components

### Context Check
- Reference `APPLICATION_SYNTAX` for manifest schema
- Reference `APPLICATION_COMPONENTS` for available components
- Check available MCP tools for data sources

### Goal
Design the application manifest structure before writing JSON.

### Actions

**1. Identify data sources:**
- Which MCP tools will provide data?
- What transformations are needed?
- Which tools return tabular data (for DataTable)?
- Which return single values (for MetricCard)?

**2. Plan the component layout:**

| Data Type | Component | Props Needed |
|-----------|-----------|--------------|
| Single value | MetricCard | title, data_source_id |
| Table data | DataTable | data_source_id, columns |
| Time series | ChartCard | title, type, data_source_id |
| Navigation | Tabs | tabs array with content |

**3. Design layout structure:**

```
Layout options:
- vstack: Vertical stack
- hstack: Horizontal stack
- grid: Grid layout
- tabs: Tabbed navigation
```

**4. Plan actions (if needed):**
- Workflow triggers: `{"type": "trigger_workflow", "workflow_id": 123}`
- MCP tool calls: `{"type": "mcp_tool", "tool_name": "..."}`

### Transitions
- Design complete → **FORM_FILL**
- Need to verify MCP tool availability → Query tools, then continue
- Design unclear → Return to **UNDERSTAND**

---

## State: FORM_FILL

### Indicators
- Application design is ready
- Need to populate the create form
- Modal should be showing the create form

### Context Check
```
page.full_path: "/applications?create=true"
data.applicationCreationState: Current form state (name/description/manifestJson/etc.)
data.patchable_text_fields: If present, should include `applicationCreationState.manifestJson`
```

### Goal
Populate the create form with application details and manifest JSON.

### Actions

**1. Build the manifest JSON:**

```json
{
  "metadata": {
    "name": "Application Name",
    "version": "1.0.0",
    "description": "What this application does"
  },
  "layout": {
    "type": "vstack",
    "gap": 16,
    "children": [
      { "element_id": "header" },
      { "element_id": "main_content" }
    ]
  },
  "ui_elements": {
    "header": {
      "component": "Header",
      "props": { "title": "Dashboard Title" }
    },
    "main_content": {
      "component": "DataTable",
      "props": { "data_source_id": "main_data" }
    }
  },
  "data_sources": {
    "main_data": {
      "type": "mcp_tool",
      "tool_name": "mcp_server_tool",
      "transformations": []
    }
  },
  "actions": {}
}
```

**2. Fill the creation form:**

```
TOOL_CALL: {"name": "ui_fill_state", "parameters": {"store_id": "applications", "updates": {"applicationCreationState": {"name": "Application Name", "description": "Brief description", "manifestJson": "{ ... full JSON manifest ... }"}}}}
```

**Field rules:**
- `name`: Required, must not be empty
- `description`: Optional but recommended
- `manifestJson`: Must be valid JSON conforming to manifest schema

**3. Verify in next context:**
- Check `data.applicationCreationState` shows the populated values
- If a JSON error field is present (commonly `data.applicationCreationState.jsonError`), it should be null/empty

### Transitions
- Form populated, no errors → **VALIDATE**
- JSON syntax error → Fix JSON, retry fill
- Form fill failed → Check error, retry once

---

## State: VALIDATE

### Indicators
- Form is populated with manifest
- Need to verify manifest structure is valid
- Haven't yet confirmed all references are correct

### Context Check
```
data.applicationCreationState.manifestJson: Should contain valid JSON
data.applicationCreationState.jsonError: Should be null/empty (if present)
```

### Goal
Verify the manifest is structurally valid before saving.

### Actions

**1. Validation checklist:**

- [ ] JSON syntax is valid (no `jsonError`)
- [ ] All `element_id` in layout exist in `ui_elements`
- [ ] All `data_source_id` references exist in `data_sources`
- [ ] All `action_id` references exist in `actions`
- [ ] All `component` names are valid (check `APPLICATION_COMPONENTS`)
- [ ] All `workflow_id` values are integers (not strings)
- [ ] Layout tree has no circular references

**2. If validation fails, use patching:**

**CRITICAL: JSON Patching Format**

When patching JSON content, format the tool call as a single valid JSON object with:
- Newlines as `\n` inside text values
- Quotes escaped as `\"` inside text values
- Indentation preserved exactly

**Correct format example:**

```
TOOL_CALL: {"name": "ui_patch_text", "parameters": {"store_id": "applications", "path": "applicationCreationState.manifestJson", "start_line": 45, "end_line": 52, "expected_text": "    \"broken_element\": {\n      \"component\": \"OldName\"\n    }", "replacement_text": "    \"fixed_element\": {\n      \"component\": \"DataTable\"\n    }"}}
```

**Key rules:**
- Keep the entire tool call as a single valid JSON object
- Use `\n` for newlines, `\"` for quotes inside text values
- Match indentation exactly (spaces, not tabs)
- Verify brace balance in both `expected_text` and `replacement_text`

**When to use patching vs full replacement:**
- Patching: Fix specific section, correct a reference, add single element
- Full replacement: Major structural changes, starting over

---

## CRITICAL: Data Source Transformation Paths

**This is the #1 mistake when creating applications that use MCP tools.**

### The Problem

When testing MCP tools directly, you see the FULL response:
```json
{
  "result": {
    "raw_response": {
      "structuredContent": { "count": 10, "events": [...] }
    }
  }
}
```

But application data source transformations receive UNWRAPPED data:
```json
{ "count": 10, "events": [...] }
```

### Correct Transformation Paths

**WRONG:**
```json
"transformations": [{
  "operation": "json_path_extract",
  "path": "result.raw_response.structuredContent.events"
}]
```

**CORRECT:**
```json
"transformations": [{
  "operation": "json_path_extract",
  "path": "events"
}]
```

### Reference Examples (Working Production App)

**SQL queries (return array of rows):**
```json
"transformations": [{
  "operation": "json_path_extract",
  "path": "[0].total"  // First row's 'total' field
}]
```

**No transformation needed:**
```json
"transformations": []  // Data is already in correct format
```

### Key Rules

1. **Never use `result.raw_response.structuredContent.*`** - the app unwraps this
2. **SQL results are arrays** - use `[0].field` for first row
3. **Check error messages** - "Available keys" shows actual structure

---

### Transitions
- All validations pass → **SAVE**
- Validation fails → Fix with patching, re-validate
- Major issues → Return to **FORM_FILL** with full replacement

---

## State: SAVE

### Indicators
- Manifest is validated
- Form is complete
- Ready to create the application

### Context Check
```
elements: Must include create/submit button (exact ID varies)
data.applicationCreationState: Must have valid values (no JSON errors)
```

### Goal
Save the application and verify success.

### Actions

**1. Check for JSON validation errors:**
- If `jsonError` is present → Fix JSON before saving

**2. Click the create button:**

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "create-application-submit-btn"}}
```

**3. Verify result:**

Check the tool result:
- `success: true` → Proceed to **COMPLETE**
- `success: false` → Read error message completely

**4. If save failed:**

| Error | Cause | Fix |
|-------|-------|-----|
| "Invalid JSON" | Malformed manifest | Fix JSON syntax |
| "Missing required field" | Empty name | Fill name field |
| "Invalid component" | Unknown component name | Check APPLICATION_COMPONENTS |
| "Invalid data source reference" | Element references non-existent DS | Fix reference or add DS |
| "Invalid workflow_id" | String instead of integer | Use number: `123` not `"123"` |

### Transitions
- Save successful → **COMPLETE**
- Save failed with fixable error → Return to **VALIDATE**
- Save failed with unclear error → Return to user with status

---

## State: COMPLETE

### Indicators
- Application has been created
- Modal has closed
- Application appears in the list

### Actions

**1. Confirm success to user:**

```
✅ **Application created successfully!**

**Application:** [name]
**Components:** [count] UI elements
**Data sources:** [count]

**Would you like to:**
- Open the application to see it in action?
- Make modifications?
```

**2. Offer logical next action:**
- Open application → Click `open-application-{id}`
- Edit application → Click `edit-application-{id}`
- Create another → Start new UNDERSTAND state

---

---

## Element IDs Reference

| Element | ID | Purpose |
|---------|-----|---------|
| Name input | `application-name` | Application name field |
| Description input | `application-description` | Description field |
| Manifest editor | `application-manifest` | JSON manifest editor |
| Load template | `load-empty-template-btn` | Load empty manifest template |
| Cancel button | `create-application-cancel-btn` | Close without creating |
| Create button | `create-application-submit-btn` | Submit and create |

---

## Common Pitfalls

1. **Skipping the create button**: Filling the form does NOT create the application—must click create.

2. **Invalid JSON syntax**: Use proper escaping, match braces, no trailing commas.

3. **Invalid component names**: Check `APPLICATION_COMPONENTS` for valid component names.

4. **Dangling references**: Every `data_source_id` and `element_id` must exist.

5. **String workflow IDs**: `workflow_id` must be an integer: `42` not `"42"`.

6. **Circular layouts**: Layout tree must be acyclic—no element can contain itself.

7. **Using patching for major changes**: For significant restructuring, use full replacement instead.

8. **Malformed JSON in patch tool calls**: When patching JSON content, ensure the tool call itself is valid JSON. Use `\n` for newlines and `\"` for quotes inside `expected_text` and `replacement_text` strings.
