---
description: "Operational Protocol: Adding an MCP Server template. State-based guidance for helping users add new MCP server templates to the platform."
globs: []
alwaysApply: false
---

# Protocol: Add MCP Server

**Purpose:** Guide the user through adding a new MCP server template to the platform.

**Prerequisites:**
- User is on `/features` page or navigable to it
- User has identified a service they want to connect (e.g., "Salesforce", "Notion", "Vapi")

---

## State Machine Overview

```
DISCOVERY ‚Üí SELECTION ‚Üí DOCUMENTATION ‚Üí FORM_FILL ‚Üí VARIABLES ‚Üí SAVE ‚Üí COMPLETE
    ‚Üë           ‚îÇ              ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò (can return if issues found)
```

---

## State: DISCOVERY

### Indicators
- User has mentioned a service name they want to connect
- No server template exists for this service yet (or user wants alternatives)
- You don't yet know what MCP server implementations are available

### Context Check
- Verify current page via `page.full_path`
- Check `data.servers` to see if template already exists

### Goal
Find suitable MCP server implementations for the requested service.

### Actions

**1. Check for available search tools:**

Before searching, verify you have search capability:
```
TOOL_CALL: {"name": "list_mcp_connections", "parameters": {}}
```

Look for search-capable servers in the response:
- `brave-search` ‚Üí Use `brave-search__brave_web_search`
- `exa` ‚Üí Use `exa__web_search_exa`
- Other search tools as available

**2. If search tool available, execute search:**

```
TOOL_CALL: {"name": "brave-search__brave_web_search", "parameters": {"query": "\"[SERVICE_NAME] MCP server\" site:github.com OR site:npmjs.com OR site:mcpservers.org"}}
```

**3. If NO search tool available:**

Do NOT attempt to call search tools that don't exist. Instead, inform the user:

```
I don't currently have access to a web search tool to find MCP server implementations.

**Options:**
1. You can connect a search integration (like Brave Search or Exa) in Settings > Integrations
2. You can provide me with a GitHub repository URL or npm package name for the MCP server you want to add
3. If you have documentation for the server, you can share the relevant details

Which would you prefer?
```

### Transitions
- Search results found ‚Üí **SELECTION**
- No search tool available ‚Üí Wait for user input, then **DOCUMENTATION** (if they provide URL) or remain in **DISCOVERY**
- User provides direct link ‚Üí **DOCUMENTATION**

---

## State: SELECTION

### Indicators
- Search results are available
- Multiple MCP server options exist
- User has not yet chosen which one to use

### Goal
Present options clearly and help user make informed choice.

### Actions

**1. Extract key information from search results:**
- Repository/package name
- Popularity indicators (stars, downloads)
- Last updated date
- Installation method (uvx, npx, docker)
- Authentication type

**2. Present as comparison table:**

```markdown
üîç **Found [N] MCP servers for [Service]:**

| # | Name | Stars | Updated | Install | Auth Type |
|---|------|-------|---------|---------|-----------|
| 1 | owner/repo-name | ‚≠ê 234 | 2024-11 | `npx` | API Key |
| 2 | owner/alternative | ‚≠ê 45 | 2024-10 | `uvx` | OAuth |

**My recommendation:** Option #1 (most popular, recently maintained, simpler auth)

Which would you like to install? (Reply with the number or name)
```

**3. Wait for user selection** - Do NOT proceed without explicit choice.

### Transitions
- User selects option ‚Üí **DOCUMENTATION**
- User wants different search ‚Üí **DISCOVERY**
- User provides their own URL ‚Üí **DOCUMENTATION**

---

## State: DOCUMENTATION

### Indicators
- A specific MCP server has been selected
- You need installation and configuration details
- You don't yet have the command, args, and environment variables

### Goal
Gather complete configuration information for the selected server.

### Actions

**1. Fetch documentation:**

If you have a search tool, search for the README:
```
TOOL_CALL: {"name": "brave-search__brave_web_search", "parameters": {"query": "[OWNER]/[REPO] README installation environment variables configuration"}}
```

Alternative queries if first doesn't yield results:
- `"[package-name]" npm installation configuration`
- `"[OWNER]/[REPO]" github mcp server setup`

**2. Extract required information:**

From the documentation, identify:
- **Command**: `npx`, `uvx`, or `docker`
- **Args**: Package name and any required arguments
- **Environment variables**: What credentials/config the server needs
- **Which variables are secrets** (API keys, tokens, passwords)

**3. If documentation is insufficient:**

```
I found the repository but couldn't extract complete configuration details.

**What I found:**
- Package: [name]
- Install method: [npx/uvx/docker]

**What I'm missing:**
- [List missing items]

Could you check the README at [URL] and let me know:
1. What environment variables are required?
2. Which ones are secrets (API keys, tokens)?
```

### Transitions
- All configuration details gathered ‚Üí **FORM_FILL**
- Documentation incomplete ‚Üí Wait for user input
- Wrong server chosen ‚Üí **SELECTION** or **DISCOVERY**

---

## State: FORM_FILL

### Indicators
- You have all configuration information
- Need to populate the add server form
- Current route should be `/features?action=add-server` (or you need to navigate there)

### Context Check
```
page.full_path: Should be "/features?action=add-server"
data.addServerForm: Shows current form state
elements: Should include form-related elements
```

### Goal
Populate ALL required form fields in a single `ui_fill_state` call.

### Actions

**1. Navigate to add server form (if not already there):**

Check `page.full_path`. If not on `/features?action=add-server`:
- If on `/features`, look for add button in `elements` and click it
- If elsewhere, navigate to `/features` first

**2. Prepare complete form data:**

All fields must be provided together:

| Field | Description | Format |
|-------|-------------|--------|
| `name` | Internal identifier | `lowercase_snake_case` (e.g., `salesforce_mcp`) |
| `display_name` | User-friendly name | Title case (e.g., `Salesforce`) |
| `description` | What the server does | Brief description |
| `config_template_json` | MCP server configuration | Escaped JSON string |
| `variable_schema_json` | Variable definitions | Escaped JSON string |
| `ui_schema_json` | Form field definitions | Escaped JSON string (NEVER empty `"{}"`) |
| `oauth_enabled` | OAuth flag | `false` for API key auth |

**3. Build the configuration JSON structures:**

**config_template_json example:**
```json
{
  "mcpServers": {
    "server_key": {
      "command": "npx",
      "args": ["-y", "@package/name"],
      "env": {
        "API_KEY": "{{api_key}}",
        "BASE_URL": "{{base_url}}"
      }
    }
  }
}
```

**variable_schema_json example:**
```json
{
  "required": ["api_key"],
  "properties": {
    "api_key": {
      "type": "string",
      "title": "API Key",
      "description": "Your service API key",
      "secret": true
    },
    "base_url": {
      "type": "string",
      "title": "Base URL",
      "description": "API endpoint URL",
      "secret": false,
      "default": "https://api.example.com"
    }
  }
}
```

**ui_schema_json example:**
```json
{
  "sections": [
    {
      "title": "API Key",
      "type": "password",
      "field": "api_key",
      "required": true,
      "helpText": "Find this in your account settings"
    },
    {
      "title": "Base URL",
      "type": "text",
      "field": "base_url",
      "placeholder": "https://api.example.com"
    }
  ]
}
```

**4. Execute form fill:**

```
TOOL_CALL: {"name": "ui_fill_state", "parameters": {"store_id": "mcp", "updates": {"addServerForm": {"name": "...", "display_name": "...", "description": "...", "config_template_json": "...", "variable_schema_json": "...", "ui_schema_json": "...", "oauth_enabled": false}}}}
```

**5. Verify in next context:**
- Check `data.addServerForm` shows populated values
- All fields should match what you submitted

### Critical Rules

**Placeholder format:** Use `{{snake_case}}` (double curly braces)

**Secret classification:**
- `true`: API keys, tokens, passwords, OAuth secrets, private keys
- `false`: URLs, paths, usernames, feature flags, ports, regions

**Field consistency:** Every `{{placeholder}}` in config_template must have:
- A matching property in `variable_schema_json`
- A matching section in `ui_schema_json`

**ui_schema_json must NOT be empty:** Always define sections for each variable, or users won't see form fields.

### Transitions
- Form verified populated ‚Üí **VARIABLES**
- Form fill failed ‚Üí Check error, fix data, retry once
- Repeated failure ‚Üí Return to user with status

---

## State: VARIABLES

### Indicators
- Form is populated with all fields
- Variables have not yet been detected
- The "Detect Variables" button should be available

### Context Check
```
elements: Should include "detect-variables-btn" or similar
data.addServerForm: Should show populated config_template_json
```

### Goal
Trigger variable detection from the config template.

### Actions

**1. Verify element exists:**

Check `elements` array for the detect variables button. Look for `id` containing "detect" or "variables".

**2. Click detect variables:**

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "detect-variables-btn"}}
```

**3. Verify in next context:**
- Variables should now be parsed from `{{placeholder}}` patterns
- The form should show detected variables or the variables tab should be populated

### Transitions
- Variables detected successfully ‚Üí **SAVE**
- Detection failed ‚Üí Check config_template_json format, return to **FORM_FILL**

---

## State: SAVE

### Indicators
- Form is complete
- Variables are detected
- Ready to create the server template

### Context Check
```
elements: Should include save/submit button
data.addServerForm: Should be fully populated
```

### Goal
Save the server template and verify success.

### Actions

**1. Verify element exists:**

Check `elements` array for submit button. Look for `id` containing "submit", "save", or "add-server".

**2. Click save:**

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "add-server-submit-btn"}}
```

**3. Verify result:**

Check the tool result:
- `success: true` ‚Üí Proceed to verify context change
- `success: false` ‚Üí Read error message completely

**4. Verify context change:**

After successful save, context should show:
- Navigation away from add form, OR
- New server appears in `data.servers` list, OR
- Modal closed

### Error Handling

**Common errors and fixes:**

| Error | Cause | Fix |
|-------|-------|-----|
| "Invalid JSON" | Malformed config_template or variable_schema | Check JSON escaping, validate structure |
| "Duplicate name" | Server with this name exists | Change `name` field to unique value |
| "Missing required field" | Form field empty | Return to FORM_FILL, add missing field |
| "Invalid variable schema" | Mismatch between template and schema | Ensure all placeholders have schema entries |

### Transitions
- Save successful (verified) ‚Üí **COMPLETE**
- Save failed with fixable error ‚Üí Return to **FORM_FILL**
- Save failed with unclear error ‚Üí Return to user with status

---

## State: COMPLETE

### Indicators
- Server template has been created
- Context shows the new server in the list or on a confirmation view

### Actions

**1. Confirm success to user:**

```
‚úÖ **Server template created successfully!**

**Server:** [display_name]
**Variables configured:** [list of variables]

**Next steps:**
- To use this server, you'll need to configure it with your credentials
- Would you like me to help you configure it now?
```

**2. Offer logical next action:**
- Configure with credentials ‚Üí Leads to HOW_TO_CONFIGURE protocol
- Create another server ‚Üí Return to DISCOVERY
- Use in workflow ‚Üí Navigate to workflow creation

---

## Reference: JSON Structure Templates

### Command Types

**npx (Node.js packages):**
```json
{
  "command": "npx",
  "args": ["-y", "@scope/package-name"],
  "env": {...}
}
```

**uvx (Python packages):**
```json
{
  "command": "uvx",
  "args": ["--from", "package-name==1.0.0", "entry-point"],
  "env": {...}
}
```

**docker:**
```json
{
  "command": "docker",
  "args": ["run", "-i", "--rm", "-e", "VAR={{var}}", "image:tag"],
  "env": {}
}
```

### UI Schema Section Types

| Type | Use For | Additional Properties |
|------|---------|----------------------|
| `password` | Secrets, API keys | Masked input |
| `text` | Plain text values | `placeholder` optional |
| `textarea` | Multi-line text | For longer content |
| `checkbox` | Multiple selections | Requires `options` array |
| `instructions` | Help text only | No `field` needed |

---

## Common Pitfalls

1. **Empty ui_schema_json**: Results in no form fields shown to users. Always define sections.

2. **Placeholder mismatch**: `{{api_key}}` in template but `apiKey` in schema. Use consistent snake_case.

3. **Missing secret flag**: API keys without `"secret": true` won't be encrypted.

4. **Wrong command for package type**: npm packages use `npx`, Python packages use `uvx`.

5. **Assuming search tool exists**: Always check `list_mcp_connections` first.

6. **Proceeding without user selection**: In SELECTION state, wait for explicit choice.
