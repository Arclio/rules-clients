---
description: "Operational Protocol: Editing an MCP Server template. State-based guidance for modifying server template settings (super_admin only)."
globs: []
alwaysApply: false
---

# Protocol: Edit MCP Server Template

**Purpose:** Guide super_admin users through modifying an existing MCP server template's settings.

**Prerequisites:**
- User has `super_admin` role (settings tab is restricted)
- An MCP server template exists that needs modification
- User understands this affects the template, not individual configurations

---

## ⚠️ Critical: Element ID Rules

**NEVER guess or construct element IDs.** Always:

1. Look in the `elements` array from context for the exact `id` value
2. Use that `id` value exactly as provided (e.g., `update-server-btn`, NOT `update-server-settings-btn`)
3. If an element is not in `elements`, it cannot be clicked

Common element IDs for this flow (always verify in context):
- Settings tab: `mcp-modal-tab-settings`
- Update button: `update-server-btn`
- Delete button: `delete-server-btn`
- Close modal: `close-mcp-server-modal-btn`

---

## Scope (Template vs Configuration)

- This SOP edits the **server template** (how the server runs, required variables, and how the config form appears). This is **super_admin only**.
- If the user wants to change **credentials / settings for their own account**, use the Configure SOP instead.

---

## State Machine Overview

```
ACCESS_SETTINGS → REVIEW_CURRENT → MODIFY_SETTINGS → SAVE_CHANGES → VERIFY_IMPACT
        ↑                                  │
        └──────────────────────────────────┘ (if save fails)
```

---

## Planning

This protocol is multi-step and high-impact. When it is loaded, your **next assistant message must include a plan** before any action.

Output the plan as a single JSON object in a `json` code block, using:
- `goal`, `current_state`, `steps`, `decision_points`, `verification`
- step `status`: `todo` | `doing` | `done` | `blocked`

Example:

```json
{
  "goal": "Edit an MCP server template (super_admin)",
  "current_state": {
    "page": "/features?action=configure&server_id=…&tab=settings",
    "server": "…"
  },
  "steps": [
    {"id": "ACCESS_SETTINGS", "status": "doing"},
    {"id": "REVIEW_CURRENT", "status": "todo"},
    {"id": "MODIFY_SETTINGS", "status": "todo"},
    {"id": "SAVE_CHANGES", "status": "todo"},
    {"id": "VERIFY_IMPACT", "status": "todo"}
  ],
  "decision_points": [
    "Confirm scope: template vs user configuration",
    "Confirm before high-impact changes (template JSON/schema/OAuth)"
  ],
  "verification": [
    "After save, the template fields reflect the new values (or UI shows success state)",
    "If changes impact existing configs, user understands required follow-up"
  ]
}
```

Update this plan as you progress (mark statuses, add brief notes).

---

## State: ACCESS_SETTINGS

### Indicators
- User wants to modify server template settings
- May or may not be in configure modal already
- Need to navigate to Settings tab

### Context Check
```
page.full_path: Check if on /features with configure action
data.activeTab: Check current tab
data.userRole or data.canEditServerSettings: Verify permission
```

### Goal
Navigate to the Settings tab of the configure modal.

### Actions

**1. Verify permission first:**

Check context for user role indicators. If not visible, attempt navigation and observe result.

**2. Open configure modal (if not already open):**

Look in `elements` for a button like `configure-server-{server_id}`.

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "configure-server-{server_id}"}}
```

**3. Navigate to Settings tab:**

Look in `elements` for the settings tab button: `mcp-modal-tab-settings`.

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "mcp-modal-tab-settings"}}
```

> **CRITICAL:** Always use the EXACT `id` from `elements` array. Never guess or construct element IDs.

**4. Verify access:**
- If successful: `data.activeTab` should be "settings"
- If denied: User will be redirected back to "configs" tab

**5. If access denied:**

```
The Settings tab is restricted to super_admin users.

If you need to modify the server template, please contact an administrator.

If you want to modify your own configuration (credentials, settings), I can help with that on the Configure tab instead.
```

### Transitions
- Settings tab accessible → **REVIEW_CURRENT**
- Access denied → Inform user, offer alternatives
- Modal open failed → Check server ID, retry

---

## State: REVIEW_CURRENT

### Indicators
- On Settings tab
- Can see current server template configuration
- Need to understand what exists before modifying

### Context Check
```
data.serverSettingsForm: Current template settings
data.serverTemplate: Full template details including:
  - display_name
  - description
  - config_template_json
  - variable_schema_json
  - ui_schema_json
  - oauth_enabled
  - oauth_handler_type (if OAuth)
  - oauth_scopes_defined_by_admin (if OAuth)
```

### Goal
Understand current configuration and confirm what user wants to change.

### Actions

**1. Summarize current settings:**

```
**Current template settings for [Server Name]:**

- **Display Name:** [value]
- **Description:** [value]
- **Command:** [npx/uvx/docker]
- **Variables:** [list of {{placeholders}}]
- **OAuth:** [Enabled/Disabled]

What would you like to modify?
```

**2. Clarify scope of changes:**

If user's request is ambiguous:
```
Just to confirm - you want to modify the server template itself, which will affect:
- How the server runs (command, arguments)
- What variables are available for configuration
- How the configuration form appears to users

Existing user configurations will NOT be automatically updated - users may need to reconfigure.

Is this what you intend?
```

### Transitions
- User confirms changes → **MODIFY_SETTINGS**
- User wants different kind of change → Redirect to appropriate protocol
- User needs to understand impact first → Explain, then proceed

---

## State: MODIFY_SETTINGS

### Indicators
- On Settings tab
- Know what changes are needed
- Ready to update form fields

### Context Check
```
data.serverSettingsForm: Current values (what we're changing)
elements: Form elements for each setting
```

### Goal
Apply the requested changes to the server template.

### Available Fields

| Field | Type | Impact of Change |
|-------|------|------------------|
| `display_name` | string | UI only - safe to change |
| `description` | string | UI only - safe to change |
| `config_template_json` | JSON string | **High impact** - may break existing configs |
| `variable_schema_json` | JSON string | **High impact** - affects configuration form |
| `ui_schema_json` | JSON string | **Medium impact** - affects form display |
| `oauth_enabled` | boolean | **High impact** - changes auth flow |
| `oauth_handler_type` | string | **High impact** - changes OAuth provider |
| `oauth_scopes_defined_by_admin` | string | **Medium impact** - may require re-auth |

### Actions

**For simple changes (display_name, description):**

```
TOOL_CALL: {"name": "ui_fill_state", "parameters": {"store_id": "mcp", "updates": {"serverSettingsForm": {"display_name": "New Display Name", "description": "Updated description"}}}}
```

**For config_template changes:**

Be extremely careful. Changes to placeholders affect variable schema.

```
TOOL_CALL: {"name": "ui_fill_state", "parameters": {"store_id": "mcp", "updates": {"serverSettingsForm": {"config_template_json": "{\"mcpServers\": {\"key\": {\"command\": \"npx\", \"args\": [...], \"env\": {...}}}}"}}}}
```

**For variable_schema changes:**

Ensure consistency with config_template placeholders.

```
TOOL_CALL: {"name": "ui_fill_state", "parameters": {"store_id": "mcp", "updates": {"serverSettingsForm": {"variable_schema_json": "{\"required\": [...], \"properties\": {...}}"}}}}
```

**For OAuth changes:**

```
TOOL_CALL: {"name": "ui_fill_state", "parameters": {"store_id": "mcp", "updates": {"serverSettingsForm": {"oauth_enabled": true, "oauth_handler_type": "google", "oauth_scopes_defined_by_admin": "https://www.googleapis.com/auth/drive,https://www.googleapis.com/auth/gmail.modify"}}}}
```

### Consistency Requirements

When modifying templates, maintain these relationships:

1. **Every `{{placeholder}}` in config_template** must have:
   - A matching property in variable_schema
   - A matching section in ui_schema

2. **Every required field in variable_schema** must:
   - Exist in config_template
   - Have a section in ui_schema

3. **OAuth scopes** must be comma-separated with NO spaces

### Transitions
- Changes applied to form → **SAVE_CHANGES**
- Validation error in form → Fix and retry
- User changes mind → Discard changes (refresh or close modal)

---

## State: SAVE_CHANGES

### Indicators
- Form has been modified
- Changes are ready to persist
- Update button is available

### Context Check
```
elements: Should include update/save button
data.serverSettingsForm: Should show modified values
```

### Goal
Save template changes and verify success.

### Actions

**1. Find the update button ID from context:**

Look in `elements` array for the button with `semantic_role: "primary_action"` or `label: "Update Server"`. The element ID will be something like `update-server-btn`.

> **CRITICAL:** Use the EXACT `id` value from `elements`. Do NOT construct or guess IDs.

**2. Click update:**

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "update-server-btn"}}
```

Note: Always verify the ID from current context - IDs may vary.

**2. Verify tool result:**
- `success: true` → Changes saved
- `success: false` → Read error carefully

**3. Handle common errors:**

| Error | Cause | Fix |
|-------|-------|-----|
| "Invalid JSON" | Malformed config_template or schema | Validate JSON structure |
| "Invalid variable schema" | Mismatch between template and schema | Ensure all placeholders have schema entries |
| "Invalid OAuth configuration" | Missing handler or scopes | Provide complete OAuth settings |

### Transitions
- Save successful → **VERIFY_IMPACT**
- Save failed → Return to **MODIFY_SETTINGS** with error context

---

## State: VERIFY_IMPACT

### Indicators
- Template changes have been saved
- Need to understand downstream effects
- May need to notify users

### Goal
Confirm changes and inform user of any required follow-up.

### Actions

**1. Confirm the change:**

```
✅ **Server template updated successfully.**

**Changes applied:**
- [List what was changed]
```

**2. Explain impact on existing configurations:**

```
**Important - Impact on existing configurations:**

[If config_template changed:]
- Existing configurations may need to be updated
- New placeholders won't have values in old configs
- Users should review and reconfigure if needed

[If OAuth settings changed:]
- Users will need to re-authorize with [Provider]
- Existing OAuth tokens may be invalidated

[If only display_name/description changed:]
- No impact on existing configurations
```

**3. Suggest next steps:**

```
**Recommended next steps:**
1. Test the server with a fresh configuration
2. Notify users who have existing configurations
3. Update any documentation referencing old settings
```

### Transitions
- User acknowledges → Complete (close modal or navigate away)
- User wants to verify → Help test with new configuration

---

## Special Case: Deleting a Server Template

### Prerequisites
- User has super_admin role
- ALL user configurations for this server must be deleted first

### Process

**1. Warn user:**

```
⚠️ **Deleting a server template is permanent and cannot be undone.**

Before deletion:
- All user configurations must be removed
- Any workflows using this server's tools will break

Are you sure you want to proceed?
```

**2. If configurations exist:**

```
This server has [N] configuration(s) that must be deleted first:
- [Config 1] (user: [email])
- [Config 2] (user: [email])

Would you like me to help delete these configurations first?
```

**3. Execute deletion:**

Look in `elements` for the delete button: `delete-server-btn`.

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "delete-server-btn"}}
```

**4. Handle confirmation dialog if present.**

**5. Verify deletion:**
- Server should no longer appear in `data.servers`
- Return to main features list

---

## Common Pitfalls

1. **Changing placeholders without updating schemas**: Creates broken configuration forms.

2. **Expecting existing configs to auto-update**: They don't - users must reconfigure.

3. **OAuth scope format**: Must be comma-separated with NO spaces between scopes.

4. **Deleting with existing configs**: Will fail - delete configs first.

5. **Testing only in settings**: Always test with a real configuration after template changes.
