---
description: "Standard Operating Procedure: Debugging a workflow. Tactical steps for the agent to follow when helping users troubleshoot workflow failures."
globs: []
alwaysApply: false
---
## SOP: Debug Workflow

**Context:** This rule is loaded when the user needs help debugging a failed workflow. The agent has access to execution logs and error details.

### Step 1: Identify the Failure

**Ask the user:**
- Which workflow failed?
- Do they have a job ID or execution link?
- What were they trying to do?

**Check the context for:**
- Execution state (should be `error` or show failed status)
- Error message
- Which step failed
- Step execution data

### Step 2: Locate the Failed Step

**In the execution data, find:**
- Step number that failed
- Step title/description
- Tool being used (if applicable)
- Error message

**Report to user:** "Step X (Title) failed with error: [message]"

### Step 3: Diagnose the Root Cause

**Common failure patterns:**

**Pattern 1: Syntax Error**
- Error mentions "invalid format", "parsing error", or "YAML"
- **Cause:** Malformed `.wf.md` file
- **Fix:** Check frontmatter syntax, step structure
- **Reference:** `WORKFLOW_SYNTAX` rule

**Pattern 2: Variable Not Found**
- Error: "Variable 'X' not found" or "undefined reference"
- **Cause:** Referencing an output that doesn't exist
- **Fix:** Check step dependencies, ensure outputs are defined correctly
- **Reference:** `WORKFLOW_PATTERNS` rule on scope isolation

**Pattern 3: Tool Execution Failed**
- Error from specific tool (e.g., "github API error", "database connection failed")
- **Cause:** Tool input was invalid OR external service failed
- **Fix:** Check tool inputs, verify service is available
- **Note:** May require retrying if it's a transient failure

**Pattern 4: Type Mismatch**
- Error: "Expected type 'X', got 'Y'"
- **Cause:** Output extraction path doesn't match actual tool response
- **Fix:** Use the Two-Step Pattern (extract as `any`, then parse with LLM)
- **Reference:** `WORKFLOW_PATTERNS` rule

**Pattern 5: Empty Array Iteration**
- Error during iterator step, often array index errors
- **Cause:** Trying to iterate over an empty array
- **Fix:** Add Guard-then-Iterate pattern (check array length first)
- **Reference:** `WORKFLOW_PATTERNS` rule

### Step 4: Propose a Fix

**Based on the diagnosis, suggest:**

1. **For syntax errors:** Show the corrected syntax
2. **For variable errors:** Explain the scope issue and how to fix it
3. **For tool errors:** Suggest checking inputs or retrying
4. **For type errors:** Recommend the Two-Step Pattern
5. **For iteration errors:** Recommend the Guard-then-Iterate pattern

**Offer to apply the fix if the user wants.**

### Step 5: Apply the Fix (if requested)

Navigate to the workflow edit page and make the correction:
- Use `ui_navigate` to go to `/workflow-edit/:id`
- Follow the Edit Workflow SOP to apply changes
- Test the fix by re-executing

### Quick Diagnosis Checklist

When you see an error, ask yourself:

- [ ] Is this a syntax/format error? → Check frontmatter and step structure
- [ ] Is a variable missing? → Check if output exists and scope is valid
- [ ] Did a tool fail? → Check tool inputs and external service status
- [ ] Is there a type mismatch? → Check extraction path vs actual output
- [ ] Is an array empty? → Check if iteration needs a guard

### Working with Execution Logs

**The execution data shows:**
- Each step's status
- Inputs sent to each tool
- Outputs received from each tool
- Timestamps and errors

**Use this to:**
- Trace data flow through the workflow
- See exactly what was sent to the failed tool
- Verify earlier steps produced expected outputs
- Identify where the data pipeline broke

### When to Escalate

**Some issues require backend investigation:**
- Tool server is completely unavailable (not just one request failing)
- Database connection issues across all workflows
- Permission/authentication errors that persist
- Platform bugs or infrastructure outages

**For these:**
- Clearly explain it's a platform issue, not workflow syntax
- Suggest checking `/monitoring` for system-wide issues
- Recommend contacting support with the job ID

### Common Pitfalls to Avoid

1. **Don't guess at fixes** - Diagnose first, then propose a solution
2. **Don't ignore the error message** - It usually points directly to the problem
3. **Don't apply untested fixes** - Explain what you'll change and why
4. **Don't confuse user error with platform issues** - Know the difference
5. **Don't forget to reference the syntax rules** - Help users learn, not just fix

### After Fixing

- Re-execute the workflow to verify the fix
- Explain what was wrong and what you changed
- Suggest best practices to avoid similar issues (e.g., always use Guard-then-Iterate)
