---
description: "Operational Protocol: Interpreting workflow results. State-based guidance for understanding execution outcomes and debugging failures."
globs: []
alwaysApply: false
---

# Protocol: Debug Workflow

**Purpose:** Help users understand workflow execution results and diagnose failures.

**Prerequisites:**
- User is on `/workflow-execute/:id?state=complete` page
- Workflow execution has finished (success or failure)
- Results are available in context

---

## State Machine Overview

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ASSESS    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ SUCCESS  â”‚              â”‚ FAILURE  â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
             â”‚                         â”‚
             â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ SUMMARIZEâ”‚              â”‚ DIAGNOSE â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
             â”‚                         â”‚
             â”‚                         â–¼
             â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚                    â”‚   FIX    â”‚
             â”‚                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
             â”‚                         â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ COMPLETE â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## State: ASSESS

### Indicators
- Workflow execution has completed
- Need to determine if it succeeded or failed
- Haven't yet analyzed the results

### Context Check
```
page.full_path: Should contain "state=complete"
execution_result: {
  status: "success" | "failed",
  steps: [...],
  outputs: {...},  // if successful
  error: {...}     // if failed
}
```

### Goal
Determine the execution outcome to choose the appropriate path.

### Actions

**1. Check `execution_result.status`:**

```
if execution_result.status == "success":
    â†’ Go to SUCCESS state
else:
    â†’ Go to FAILURE state
```

### Transitions
- Status is "success" â†’ **SUCCESS**
- Status is "failed" â†’ **FAILURE**

---

## State: SUCCESS

### Indicators
- `execution_result.status` is "success"
- Workflow completed without errors
- Outputs are available

### Context Check
```
execution_result.status: "success"
execution_result.outputs: Final workflow outputs
execution_result.steps: All steps with status "completed"
```

### Goal
Understand what the workflow produced.

### Actions

**1. Review outputs:**
- Check `execution_result.outputs` for final results
- Note the data types and structure

**2. Review step execution:**
- Check each step in `execution_result.steps`
- Note duration and any intermediate outputs

### Transitions
- Outputs understood â†’ **SUMMARIZE**

---

## State: FAILURE

### Indicators
- `execution_result.status` is "failed"
- One or more steps did not complete
- Error information is available

### Context Check
```
execution_result.status: "failed"
execution_result.steps: Array with at least one failed step
execution_result.error: Top-level error info
```

### Goal
Identify which step failed and why.

### Actions

**1. Find the failed step:**

Look through `execution_result.steps` for:
- `status: "failed"` or `status: "error"`
- The `error` field with the message
- The `step_id` and `title`

**2. Extract error details:**

```
Step [N] ([title]) failed with error: [error message]
```

### Transitions
- Failed step identified â†’ **DIAGNOSE**

---

## State: DIAGNOSE

### Indicators
- Failed step is identified
- Need to determine root cause
- Error message is available

### Context Check
- Error message from failed step
- Step inputs and configuration
- Previous step outputs (if applicable)

### Goal
Determine the root cause of the failure.

### Actions

**1. Categorize the error:**

| Error Pattern | Category | Likely Cause |
|--------------|----------|--------------|
| "Invalid format", "parsing error", "YAML" | **Syntax** | Malformed workflow definition |
| "Variable 'X' not found", "undefined" | **Reference** | Dangling variable reference |
| "API error", "connection failed", "timeout" | **Tool** | External service or input issue |
| "Expected type 'X', got 'Y'" | **Type** | Output structure mismatch |
| "Missing parameter", "Invalid parameter" | **Parameter** | Workflow parameter issue |
| "Permission denied", "unauthorized" | **Auth** | Credentials or access issue |

**2. Explain the diagnosis:**

```
ğŸ“ **Diagnosis:** [Category] Error

**What happened:**
Step [N] ([title]) failed because [clear explanation].

**Root cause:**
[Specific cause based on error pattern]
```

### Transitions
- Diagnosis complete â†’ **FIX**

---

## State: FIX

### Indicators
- Root cause is understood
- Need to recommend a fix
- User needs guidance on next steps

### Context Check
- Diagnosis from previous state
- Available actions in context
- Whether fix requires workflow edit or just re-run

### Goal
Propose a concrete fix for the failure.

### Actions

**1. Determine fix type:**

| Category | Fix Type | Action |
|----------|----------|--------|
| **Syntax** | Edit workflow | Navigate to edit page |
| **Reference** | Edit workflow | Fix variable names |
| **Tool** | Re-run or Edit | Check inputs, retry, or fix params |
| **Type** | Edit workflow | Fix extraction paths |
| **Parameter** | Re-run | Use correct parameter values |
| **Auth** | Configure | Check credentials/permissions |

**2. For Re-run fixes:**

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "rerun-workflow-btn"}}
```

Or suggest the user try again with different parameters.

**3. For Edit fixes:**

```
This issue requires editing the workflow definition.
Would you like me to navigate to the edit page and fix [specific issue]?
```

If user confirms:
```
TOOL_CALL: {"name": "ui_navigate", "parameters": {"url": "/workflow-edit/{workflow_id}"}}
```

Then follow `HOW_TO_EDIT_WORKFLOW` protocol.

**4. For transient failures:**

If the error seems temporary (timeout, rate limit):
- Suggest a simple retry
- No workflow changes needed

### Transitions
- Fix requires re-run â†’ Execute action, go to **COMPLETE**
- Fix requires edit â†’ Navigate to edit page (ends this protocol)
- User declines fix â†’ **COMPLETE**

---

## State: SUMMARIZE

### Indicators
- Workflow succeeded
- Outputs are understood
- Need to present results to user

### Context Check
```
execution_result.outputs: Final results
execution_result.steps: Execution timeline
```

### Goal
Present the results clearly to the user.

### Actions

**1. Format results based on type:**

**For data/text outputs:**
```
âœ… **Workflow completed successfully!**

**Results:**
[Format data in readable way - tables, lists, or plain text as appropriate]

**Execution time:** [started_at to completed_at]
**Steps completed:** [count]
```

**For file outputs:**
```
âœ… **Workflow completed successfully!**

**Output files generated:**
- [file name] - [description]

These are available for download using the button below.
```

**For multiple items:**
```
âœ… **Workflow completed successfully!**

**Processed [N] items:**
1. [item 1 summary]
2. [item 2 summary]
...
```

### Transitions
- Summary complete â†’ **COMPLETE**

---

## State: COMPLETE

### Indicators
- Results have been presented (success or failure handled)
- User has received all relevant information
- Ready for next action

### Context Check
```
elements: Available actions (download, rerun, etc.)
```

### Goal
Offer logical next actions to the user.

### Actions

**1. List available actions:**

Look in context for available actions:
- `download_results` - Download output files
- `start_new_run` - Run again with same/different parameters
- `return_to_application` - Go back (if launched from an app)
- `edit_workflow` - Navigate to edit page

**2. Suggest appropriate next step:**

For success:
```
**What would you like to do next?**
- Download the results
- Run again with different parameters
- Make modifications to the workflow
```

For failure (after fix):
```
Would you like to:
- Try running the workflow again
- Make changes to the workflow
- Do something else
```

---

## Reference: Error Message Patterns

### Syntax Errors
```
"YAML parsing error at line 15"
"Invalid frontmatter: missing 'version' field"
"Step 3 missing required field: **Tool:**"
```
**Fix:** Edit workflow to correct syntax

### Variable Errors
```
"Variable 'step2.data' not found"
"Cannot resolve reference: ${unknown.field}"
"Step 4 references undefined output"
```
**Fix:** Check step outputs, fix variable names

### Tool Errors
```
"Tool 'mcp_server_tool' not found"
"API error: 429 Too Many Requests"
"Connection timeout after 30s"
```
**Fix:** Verify tool name, check service, retry

### Type Errors
```
"Expected array, got object at $.results"
"Cannot extract string from null"
"Type mismatch: expected number"
```
**Fix:** Verify tool response structure, fix extraction path

### Parameter Errors
```
"Missing required parameter: email"
"Invalid value for 'limit': expected number"
"Parameter 'date' format invalid"
```
**Fix:** Re-run with correct parameters

---

## Common Pitfalls

1. **Guessing at fixes**: Always read the error message firstâ€”it tells you what's wrong.

2. **Ignoring error details**: The error message often contains the exact issue and location.

3. **Assuming user error**: Could be a transient failureâ€”check before suggesting edits.

4. **Editing for parameter issues**: If parameters were wrong, just re-runâ€”no edit needed.

5. **Losing context**: Reference specific step IDs and error messages in explanations.

6. **Not offering next actions**: Always give the user clear options for what to do next.

7. **Suggesting edits for auth issues**: Authentication problems need credential setup, not workflow edits.
