---
description: "Standard Operating Procedure: Creating a workflow. Tactical steps for the agent to follow when creating a workflow on behalf of a user."
globs: []
alwaysApply: false
---
## SOP: Create Workflow

**Context:** This rule is loaded when the user is on the workflow creation page or modal. The agent is already in the creation context.

### Step 1: Understand What the User Wants

Ask clarifying questions if needed:
- What should the workflow do (high-level goal)?
- What data sources or APIs are involved?
- What is the expected output?

### Step 2: Identify Required MCP Tools

**Action:** Query the available MCP tools to see what's available.

- Use MCP tool discovery (if available in context) to list available tools
  - **Note:** When querying tools for a specific server, ALWAYS use `snake_case` (e.g., `google_workspace`, not "Google Workspace").
- Match user requirements to available tools
- For each tool you plan to use, call it individually with test inputs to verify:
  - What parameters it accepts
  - What structure it returns
  - Any quirks or edge cases

**Why:** You cannot write a valid workflow without knowing the exact tool signatures and output structures.

### Step 3: Draft and Validate Content (CRITICAL)

**Reference:** Load and follow `WORKFLOW_SYNTAX` and `WORKFLOW_PATTERNS` rules. Start from the **Golden Template** in `WORKFLOW_SYNTAX`.

**Action:** Before calling any UI tool, mentally draft the `.wf.md` content and run through the validation checklist.

**Required elements:**
1. **Frontmatter** (YAML block at top):
   - `title`: Short, descriptive name
   - `description`: One-sentence summary
   - `version`: "2.1"
   - `autonomous`: true
   - `parameters`: **REQUIRED if you use `${workflow.params.*}` anywhere!**

2. **Steps** (one or more):
   - Each step must have: `## Step N: Title`
   - Each step must specify either `**Tool:**` or `**Type:**`
   - Define `**Inputs:**` for tool parameters
   - Define `**Outputs:**` with variable name, type, and extraction path

**⚠️ VALIDATION CHECKLIST (Run through this BEFORE filling the form):**

| Check | What to Verify |
|-------|----------------|
| ✅ Parameters declared | Every `${workflow.params.X}` has matching entry in `parameters:` block |
| ✅ LLM model specified | Every `llm` tool step has `model: "anthropic/claude-sonnet-4-5"` (or other valid model) |
| ✅ LLM inputs complete | Every `llm` step has `system_prompt`, `user_prompt`, AND `model` |
| ✅ Steps numbered | Steps are numbered sequentially: 1, 2, 3... |
| ✅ Variable references valid | Every `${stepN.var}` references a declared output |
| ✅ No scope violations | Child step outputs not accessed from parent scope |
| ✅ Tool names correct | Tool names match those verified in Step 2 |
| ✅ Internet search uses LLM | For web search, use `llm` tool (NOT `brave_search__*`) |

**Common Validation Failures (Avoid These):**
- ❌ `Workflow references undeclared parameters: week_start` → Add `week_start` to `parameters:` block
- ❌ `LLM call missing required 'model' parameter` → Add `model: "anthropic/claude-sonnet-4-5"`


### Step 4: Fill the Creation Form

Use `ui_fill_state` to populate the form:

```json
{
  "store_name": "workflow",
  "state_path": "workflowCreationState",
  "updates": {
    "title": "Workflow Title",
    "description": "Brief description",
    "scenario": "1. Fetch calendar events for the week\n2. Analyze events with LLM\n3. Generate summary document\n4. Save to Google Drive",
    "content": "---\ntitle: ...\n..."
  }
}
```

**Field Requirements:**

| Field | Purpose | Guidelines |
|-------|---------|------------|
| `title` | Workflow name | Short, descriptive (e.g., "Weekly Calendar Summary") |
| `description` | One-sentence summary | Brief overview of what it does |
| `scenario` | **Human-readable step breakdown** | See below - THIS IS CRITICAL |
| `content` | The `.wf.md` workflow definition | Must pass validation from Step 3 |

#### The `scenario` Field (CRITICAL FOR USER UNDERSTANDING)

The `scenario` field is **NOT** part of the `.wf.md` syntax - it's a form field that provides a **human-readable summary** of what the workflow does, step by step.

**Why it matters:** Users may not understand workflow syntax, but they CAN understand the scenario. It lets them verify the workflow does what they expect.

**How to write a good scenario:**
- Break down the workflow into numbered, plain-English steps
- Each step should describe WHAT happens, not HOW (no technical details)
- Keep it concise but complete

**Good scenario example:**
```
1. Get all calendar events for the specified week
2. Analyze the events and identify key meetings
3. Generate a formatted summary with daily breakdown
4. Create a Google Doc with the summary
5. Share the document link
```

**Bad scenario example (too technical):**
```
Execute google_workspace__calendar_get_events with time_min and time_max params,
then call llm tool with claude-sonnet-4-5 to analyze...
```

### Step 5: **SAVE the Workflow** (CRITICAL STEP)

**⚠️ IMPORTANT:** Filling the form does NOT create the workflow. You MUST click the save button.

**Action Required:**

1. **Check button state** in `page_data.buttons.create`:
   - If `enabled: false` → Check `enabled_reason` to see what's missing (usually title)
   - If `enabled: true` → Proceed to step 2

2. **Click the save button:**
   ```json
   ui_trigger_click({"element_id": "create-workflow-submit-btn"})
   ```

3. **Wait for and READ the tool result:**
   - **Success:** `{success: true}` → Workflow created! Continue to Step 6
   - **Error:** `{success: false, errors: [...]}` → **READ the error messages**
     - Common errors: Invalid syntax, missing required fields, tool name typos
     - **FIX the workflow content** based on error message
     - **Return to Step 4** to update the form with corrected content
     - **Retry this step** (click save again)

**DO NOT** tell the user "workflow created" until you receive `success: true` from the save button click.

### Step 6: Confirm Success and Next Steps

After receiving `success: true` from the save button:

- Close the creation modal
- Workflow now appears in the workflow gallery
- **You will remain on the workflow list page** (No auto-redirect)

**Inform the user:**
- Workflow was successfully created ✅
- It is now visible in the list
- Ask if they want to **Run** it or **Edit** it now

### Common Pitfalls to Avoid

1. **Don't skip the save step** - Filling the form ≠ Creating the workflow
2. **Don't ignore error messages** - If save fails, READ the error and fix the issue
3. **Don't guess tool signatures** - Always verify before writing the workflow
4. **Don't skip frontmatter** - It's required
5. **Don't create dangling variable references** - Every `${stepN.var}` must exist
6. **Don't use tools you haven't tested** - You need to know their output structure
7. **Don't assume success** - Wait for explicit confirmation from tool results
8. **Don't forget `parameters:`** - If you use `${workflow.params.X}`, declare X in frontmatter
9. **Don't forget `model:` in LLM steps** - Always include `model: "anthropic/claude-sonnet-4-5"`
10. **Don't use old/invalid model names** - Only use models from the supported list in `WORKFLOW_TOOLING`
11. **Don't use Brave Search for web research** - Use `llm` tool instead (proper output format)
