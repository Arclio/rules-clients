---
description: "Operational Protocol: Creating a workflow. State-based guidance for helping users create new workflows on the platform."
globs: []
alwaysApply: false
---

# Protocol: Create Workflow

**Purpose:** Guide the user through creating a new workflow with valid syntax and verified tool integrations.

**Prerequisites:**
- User is on `/workflow?mode=create` page or navigable to it
- User has identified what they want the workflow to accomplish

---

## State Machine Overview

```
UNDERSTAND → DISCOVER_TOOLS → DRAFT → FORM_FILL → SAVE → COMPLETE
    ↑              │             │
    └──────────────┴─────────────┘ (can return if issues found)
```

---

## State: UNDERSTAND

### Indicators
- User has mentioned a task or goal they want to automate
- The specific requirements are not yet fully understood
- You don't know what data sources, APIs, or outputs are involved

### Context Check
- Verify current page via `page.full_path`
- Check if user is already on workflow creation page

### Goal
Clarify the user's requirements before proceeding.

### Actions

**1. Ask clarifying questions if needed:**
- What should the workflow do (high-level goal)?
- What data sources or APIs are involved?
- What is the expected output?

**2. Summarize understanding before proceeding:**

```
I understand you want to create a workflow that:
- [Goal 1]
- [Goal 2]
- Expected output: [Output description]

Is that correct?
```

### Transitions
- User confirms understanding → **DISCOVER_TOOLS**
- User provides more requirements → Remain in **UNDERSTAND**
- Requirements are already clear from initial request → **DISCOVER_TOOLS**

---

## State: DISCOVER_TOOLS

### Indicators
- Requirements are understood
- You need to identify which MCP tools can fulfill the requirements
- You haven't yet verified tool signatures and outputs

### Context Check
- Check available MCP servers via `list_mcp_connections`
- Note which servers might have relevant tools

### Goal
Identify and verify the exact tool signatures needed for the workflow.

### Actions

**1. List available MCP tools:**

```
TOOL_CALL: {"name": "list_mcp_connections", "parameters": {}}
```

**2. For each server that might have relevant tools, explore:**

```
TOOL_CALL: {"name": "get_mcp_tools_for_server", "parameters": {"server_name": "server_name_in_snake_case"}}
```

**Important:** Server names MUST be in `snake_case` (e.g., `google_workspace`, not "Google Workspace").

**3. For each tool you plan to use, get the full schema:**

```
TOOL_CALL: {"name": "get_mcp_tool_schema", "parameters": {"server_name": "server_name", "tool_name": "tool_name"}}
```

**4. Test tools with sample inputs to verify:**
- What parameters they accept
- What structure they return
- Any quirks or edge cases

### Transitions
- All required tools identified and verified → **DRAFT**
- Tool not available → Inform user, ask for alternatives or return to **UNDERSTAND**
- Tool returns unexpected structure → Note for workflow design, proceed to **DRAFT**

---

## State: DRAFT

### Indicators
- Required tools are identified and verified
- Ready to write the workflow content
- Workflow syntax not yet written

### Context Check
- Reference `WORKFLOW_SYNTAX` for correct format
- Reference `WORKFLOW_PATTERNS` for best practices
- Reference `WORKFLOW_TOOLING` for tool usage patterns

### Goal
Create valid workflow content in `.wf.md` format.

### Actions

**1. Build the frontmatter:**

```yaml
---
title: "Short, descriptive name"
description: "One-sentence summary"
version: "2.1"
autonomous: true
---
```

**2. Define each step:**

Each step must have:
- `## Step N: Title`
- `**Tool:**` or `**Type:**`
- `**Inputs:**` for tool parameters
- `**Outputs:**` with variable name, type, and extraction path

**3. Validation checklist:**

Before proceeding, verify:
- [ ] Frontmatter has all required fields
- [ ] Every step is numbered sequentially
- [ ] Every variable reference (`${...}`) points to a defined output
- [ ] No scope violations (child step outputs accessed from parent)
- [ ] Tool names match those verified in DISCOVER_TOOLS
- [ ] Output extraction paths match verified tool responses

### Transitions
- Workflow content is valid → **FORM_FILL**
- Syntax issues found → Fix and re-validate in **DRAFT**
- Need to verify additional tools → Return to **DISCOVER_TOOLS**

---

## State: FORM_FILL

### Indicators
- Valid workflow content is ready
- Need to populate the creation form
- Current route should be `/workflow?mode=create`

### Context Check
```
page.full_path: Should be "/workflow?mode=create"
data.workflowCreationState: Shows current form state
elements: Should include form-related elements
```

### Goal
Populate ALL required form fields with the prepared workflow content.

### Actions

**1. Navigate to create page (if not already there):**

Check `page.full_path`. If not on `/workflow?mode=create`:
- Navigate to `/workflow` first
- Look for create button in `elements` and click it

**2. Fill the creation form:**

```
TOOL_CALL: {"name": "ui_fill_state", "parameters": {"store_id": "workflow", "updates": {"workflowCreationState": {"title": "Workflow Title", "description": "Brief description", "scenario": "data_processing", "content": "---\ntitle: ...\n..."}}}}
```

**Field rules:**
- `title`: Must not be empty
- `scenario`: Pick appropriate category based on workflow type
- `content`: Must be valid `.wf.md` (validated in DRAFT state)

**3. Verify in next context:**
- Check `data.workflowCreationState` shows populated values
- All fields should match what you submitted

### Transitions
- Form verified populated → **SAVE**
- Form fill failed → Check error, fix data, retry once
- Repeated failure → Return to user with status

---

## State: SAVE

### Indicators
- Form is populated with all fields
- Ready to create the workflow
- Save button should be available

### Context Check
```
elements: Should include submit button
page_data.buttons.create: Check if enabled
```

### Goal
Save the workflow and verify success.

### Actions

**1. Check button state:**

Look at `page_data.buttons.create`:
- If `enabled: false` → Check `enabled_reason` to see what's missing
- If `enabled: true` → Proceed to save

**2. Click the save button:**

```
TOOL_CALL: {"name": "ui_trigger_click", "parameters": {"element_id": "create-workflow-submit-btn"}}
```

**3. Verify result:**

Check the tool result:
- `success: true` → Proceed to **COMPLETE**
- `success: false` → Read error message completely

**4. If save failed:**

Common errors and fixes:

| Error | Cause | Fix |
|-------|-------|-----|
| "Invalid syntax" | Malformed workflow content | Check YAML frontmatter and step format |
| "Missing required field" | Empty title or content | Return to FORM_FILL, add missing field |
| "Invalid tool reference" | Tool name typo | Verify tool name from DISCOVER_TOOLS |
| "Variable not found" | Dangling reference | Check step outputs and variable names |

### Transitions
- Save successful (verified) → **COMPLETE**
- Save failed with fixable error → Return to **DRAFT** or **FORM_FILL**
- Save failed with unclear error → Return to user with status

---

## State: COMPLETE

### Indicators
- Workflow has been created
- Context shows the new workflow in the list or confirmation view

### Actions

**1. Confirm success to user:**

```
✅ **Workflow created successfully!**

**Workflow:** [title]
**Steps:** [number of steps]

**Next steps:**
- Would you like to run this workflow now?
- Would you like to make any modifications?
```

**2. Offer logical next action:**
- Run workflow → Navigate to execution page
- Edit workflow → Navigate to edit page
- Create another → Return to UNDERSTAND for new workflow

---

## Reference: Workflow Syntax Templates

### Frontmatter

```yaml
---
title: "Workflow Title"
description: "What this workflow does"
version: "2.1"
autonomous: true
---
```

### Step with MCP Tool

```markdown
## Step 1: Fetch Data

**Tool:** mcp_server-name_tool_name
**Inputs:**
- `param1`: "value"
- `param2`: ${previous_step.output}
**Outputs:**
- `data` (object): $.result.data
```

### Step with LLM

```markdown
## Step 2: Analyze Results

**Type:** llm
**Inputs:**
- `prompt`: "Analyze this data: ${step1.data}"
**Outputs:**
- `analysis` (string): The analysis result
```

### Conditional Step

```markdown
## Step 3: Conditional Processing

**Type:** conditional
**Condition:** ${step2.analysis.needs_processing} == true
**If True:**
  ## Step 3.1: Process Data
  **Tool:** processor_tool
  ...
```

---

## Common Pitfalls

1. **Skipping tool verification**: Always test tools before writing workflow—you need exact signatures.

2. **Using wrong tool name format**: MCP tool names are `mcp_{server}_{tool}` with underscores for spaces.

3. **Dangling variable references**: Every `${stepN.var}` must point to a defined output.

4. **Skipping the save step**: Filling the form ≠ Creating the workflow. Always click save.

5. **Ignoring save errors**: If save fails, READ the error message—it tells you what's wrong.

6. **Not validating extraction paths**: Verify tool response structure matches your `$.path` expressions.

7. **Assuming success without confirmation**: Wait for explicit `success: true` from save button.
